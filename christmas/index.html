<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÎàÑÎçïÎàÑÎçï ÌÅ¨Î¶¨Ïä§ÎßàÏä§ ÌÜ° (Center Aligned)</title>
    <link rel="icon" type="image/png" href="./ico.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>

    <style>
        :root {
            --primary-color: #d32f2f;
            --secondary-color: #2e7d32;
            --bg-color: #222222;
            --surface-color: #ffffff;
            --border-color: #e0e0e0;
            --header-color: #d32f2f;
        }

        * { box-sizing: border-box; outline: none; }
        body {
            margin: 0; padding: 0;
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh;
            color: #333;
        }


        .layout-wrapper {
            display: flex; align-items: center; justify-content: center;
            gap: 60px; max-width: 1200px; padding: 40px;
        }

        .preview-area { position: relative; }


        #loadingOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 999;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            color: white; backdrop-filter: blur(5px); border-radius: 40px;
        }

        #resultModalOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-card {
            background: white; width: 320px; padding: 30px; border-radius: 20px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-btn {
            padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 14px;
            width: 100%; margin-top: 15px; background: #333; color: white;
        }


        #captureTarget {
            padding: 40px; 
            background-color: transparent; 
            display: inline-block;
        }
        #captureTarget.capturing-mode * {
            box-shadow: none !important; 
            text-shadow: none !important;
        }

        .bezel-body {
            width: 400px; height: 740px; 
            background-color: #111; 
            border-radius: 50px; 
            padding: 15px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.5); 
            display: flex; flex-direction: column;
            position: relative;
        }
        .capturing-mode .bezel-body { box-shadow: none !important; }

        .phone-screen {
            flex: 1;
            background-color: #fff;
            border-radius: 35px;
            overflow: hidden;
            display: flex; flex-direction: column;
            position: relative;
            transform: translateZ(0);
        }

        .app-header {
            background-color: var(--header-color);
            color: white; 
            padding: 15px 18px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 50; flex-shrink: 0; position: relative; 
            transition: background-color 0.3s;
        }
        .header-left { display: flex; align-items: center; gap: 10px; flex: 1; overflow: hidden; }
        .header-title { font-size: 16px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-icons { display: flex; gap: 15px; }
        .header-icon { font-size: 22px; cursor: pointer; }

        .chat-screen {
            flex: 1; 
            padding: 10px 15px 20px 15px; 
            background-color: #1c1c1c;
            background-size: cover; background-position: center;
            overflow-y: auto;
            display: flex; flex-direction: column; 
            justify-content: flex-start;
            gap: 6px; 
            position: relative;
        }
        .chat-screen::-webkit-scrollbar { width: 0px; }

        /* --- Ïª®Ìä∏Î°§ Ìå®ÎÑê --- */
        .control-panel {
            width: 450px; background: var(--surface-color); border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; max-height: 800px;
        }
        .panel-body { padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; border-radius: 24px; }
        .panel-body::-webkit-scrollbar { width: 6px; }
        .panel-body::-webkit-scrollbar-thumb { background: #eee; border-radius: 3px; }

        .card { background: white; border-radius: 12px; padding: 15px; border: 1px solid #eee; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .section-label { font-size: 13px; font-weight: 700; color: #888; display: flex; align-items: center; gap: 6px; text-transform: uppercase; margin: 0; }

        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%;}
        .btn-file {
            border: 1px solid #eee; color: #555; background-color: #fafafa;
            padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
            width: 100%; transition: 0.2s;
        }
        .btn-file:hover { background: #eee; }
        .btn-file input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }

        .profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .profile-config { display: flex; flex-direction: column; align-items: center; gap: 8px; background: #fafafa; padding: 10px; border-radius: 10px; border: 1px solid #eee;}
        .profile-preview-circle {
            width: 50px; height: 50px; border-radius: 50%; background: #e0e0e0;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .profile-preview-circle img { width: 100%; height: 100%; object-fit: cover; }
        
        .input-field {
            width: 100%; padding: 10px; border: 1px solid #eee; border-radius: 8px;
            font-size: 13px; background: #fafafa; transition: 0.2s;
        }
        .input-field:focus { border-color: #bbb; background: #fff; }

        .toggle-group { display: flex; background: #f0f0f0; border-radius: 8px; padding: 3px; gap: 3px; margin-bottom: 12px; }
        .toggle-item {
            flex: 1; border: none; background: transparent; padding: 8px; border-radius: 6px;
            font-size: 13px; font-weight: 600; color: #888; cursor: pointer; transition: 0.2s;
        }
        .toggle-item.active { background: white; color: #333; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .toggle-item.active.red-theme { color: var(--primary-color); }
        .toggle-item.active.green-theme { color: var(--secondary-color); }

        .btn-main {
            width: 100%; padding: 12px; border: none; border-radius: 10px;
            font-size: 14px; font-weight: 700; color: white; cursor: pointer;
            background: #333; display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 10px;
            transition: 0.2s;
        }
        .btn-main:hover { transform: translateY(-1px); opacity: 0.9; }
        .btn-generate { background: linear-gradient(135deg, #2e7d32, #1b5e20); box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3); }


        .chat-row { 
            display: flex; gap: 8px; opacity: 1; margin: 0; padding: 0; width: 100%;
            align-items: flex-start; z-index: 20; position: relative;
        }
        .chat-row.left { flex-direction: row; }
        .chat-row.left .bubble { background: var(--primary-color); color: white; border-top-left-radius: 2px; }
        .chat-row.right { flex-direction: row-reverse; }
        .chat-row.right .bubble { background: var(--secondary-color); color: white; border-top-right-radius: 2px; }

        .profile-area { display: flex; flex-direction: column; align-items: center; width: 48px; flex-shrink: 0; }
        .profile-img-s { width: 42px; height: 42px; border-radius: 50%; background: #ddd; overflow: hidden; border: 1px solid rgba(0,0,0,0.1); }
        .profile-img-s img { width: 100%; height: 100%; object-fit: cover; }
        .profile-name-s { font-size: 10px; margin-top: 3px; background: rgba(0,0,0,0.3); color: white; padding: 1px 4px; border-radius: 4px; white-space: nowrap; }

        .delete-btn {
            position: absolute; top: -8px; right: -8px;
            width: 20px; height: 20px; background: #333; color: white;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 12px; font-weight: bold; cursor: pointer;
            opacity: 0; transition: opacity 0.2s; z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .bubble:hover .delete-btn, .gift-card:hover .delete-btn { opacity: 1; }
        .capturing-mode .delete-btn { display: none !important; }

        .bubble {
            padding: 9px 12px 6px 12px; 
            border-radius: 16px; max-width: 240px; font-size: 14px; line-height: 1.3; 
            box-shadow: 0 1px 1px rgba(0,0,0,0.05); position: relative; display: block; word-break: break-word;
            margin-top: 10px; 
        }

        .gift-card { 
            background: white; width: 220px; border-radius: 12px; overflow: hidden; 
            box-shadow: none; border: 1px solid rgba(0,0,0,0.1); position: relative; 
            margin-top: 10px; 
        }
        .gift-header { padding: 8px 12px; font-size: 11px; font-weight: bold; color: white; background: var(--primary-color); }
        .gift-card.green-theme .gift-header { background: var(--secondary-color); }
        .gift-img-area { width: 100%; height: 130px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .gift-img-area img { width: 100%; height: 100%; object-fit: cover; }
        .gift-content { padding: 12px 12px 10px 12px; }
        .gift-title { font-size: 14px; font-weight: bold; margin-bottom: 3px; color: #212121; }
        .gift-desc { font-size: 11px; color: #666; line-height: 1.3; }

        .color-row { display: flex; gap: 8px; margin-top: 10px; }
        .color-group { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .color-group label { font-size: 10px; color: #999; font-weight: bold; }
        .color-input-box { width: 100%; height: 30px; border-radius: 6px; overflow: hidden; position: relative; border: 1px solid #ddd; }
        .color-input-box input[type="color"] { width: 150%; height: 150%; position: absolute; top: -5px; left: -5px; cursor: pointer; border: none;}

        #giftPreviewArea {
            margin: 12px auto 0; display: none; width: 220px; height: 130px;
            border-radius: 12px; overflow: hidden; border: 1px solid #eee; background: #f5f5f5;
        }
        #giftPreviewImg { width: 100%; height: 100%; object-fit: cover; display: block; }


        #cropper-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 3000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        #cropper-modal.show { display: flex; }

        .canvas-container {
            border: 2px solid #555; background: #000;
            overflow: hidden; touch-action: none;
            display: flex; justify-content: center; align-items: center;
            border-radius: 12px; margin-bottom: 20px;
            cursor: move;
            max-width: 90vw;
            max-height: 70vh;
        }

        .cropper-controls {
            display: flex; flex-direction: column; gap: 15px; width: 300px;
            background: #222; padding: 20px; border-radius: 16px;
        }
        .control-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; color: white; font-size: 14px; }
        .slider-container { flex: 1; display: flex; align-items: center; gap: 10px; }
        .slider-container input[type=range] { flex: 1; cursor: pointer; }

        .btn-icon {
            background: #444; color: white; border: none; border-radius: 8px;
            width: 36px; height: 36px; display: flex; justify-content: center; align-items: center;
            cursor: pointer;
        }
        .btn-icon:hover { background: #555; }

        .cropper-btns { display: flex; gap: 10px; margin-top: 10px; }
        .btn-crop-cancel { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #555; background: transparent; color: #ccc; cursor: pointer; }
        .btn-crop-apply { flex: 2; padding: 12px; border-radius: 8px; border: none; background: var(--secondary-color); color: white; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>

    <div id="resultModalOverlay">
        <div class="modal-card">
            <span class="material-icons-round" style="font-size: 50px; color: #2e7d32; margin-bottom: 10px;">check_circle</span>
            <h2 style="margin:0 0 10px 0; font-size: 20px;">GIF ÏÉùÏÑ± ÏôÑÎ£å!</h2>
            <p style="margin:0; font-size: 14px; color: #666;">ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.</p>
            <button class="modal-btn" onclick="closeModal()">ÌôïÏù∏</button>
        </div>
    </div>

    <div id="cropper-modal">
        <div class="canvas-container" id="canvasContainer">
            <canvas id="cropper-canvas"></canvas>
        </div>
        <div class="cropper-controls">
            <div class="control-row">
                <span>ÌôïÎåÄ/Ï∂ïÏÜå</span>
                <div class="slider-container">
                    <span class="material-icons-round" style="font-size:16px;">remove</span>
                    <input type="range" id="crop-zoom" min="0.1" max="3" step="0.1" value="1">
                    <span class="material-icons-round" style="font-size:16px;">add</span>
                </div>
            </div>
            <div class="control-row">
                <span>ÌöåÏ†Ñ</span>
                <div style="display:flex; gap:5px;">
                    <button class="btn-icon" onclick="rotateImage(-90)"><span class="material-icons-round">rotate_left</span></button>
                    <button class="btn-icon" onclick="rotateImage(90)"><span class="material-icons-round">rotate_right</span></button>
                </div>
            </div>
            <div class="cropper-btns">
                <button class="btn-crop-cancel" onclick="closeCropper()">Ï∑®ÏÜå</button>
                <button class="btn-crop-apply" onclick="applyCrop()">Ï†ÅÏö©ÌïòÍ∏∞</button>
            </div>
        </div>
    </div>

    <div class="layout-wrapper">
        <div class="preview-area">
            <div id="loadingOverlay">
                <span class="material-icons-round fa-spin" style="font-size:40px; margin-bottom:10px;">hourglass_top</span>
                <div style="font-weight:bold; font-size:18px;">GIF ÏÉùÏÑ± Ï§ë...</div>
            </div>

            <div id="captureTarget">
                <div class="bezel-body">
                    <div class="phone-screen">
                        <div class="app-header">
                            <div class="header-left">
                                <span class="material-icons-round" style="font-size:20px; cursor:pointer;">arrow_back_ios_new</span>
                                <div class="header-title" id="roomNameDisplay">ÌÅ¨Î¶¨Ïä§ÎßàÏä§ ÌååÌã∞Î∞© üéÑ</div>
                            </div>
                            <div class="header-icons">
                                <span class="material-icons-round header-icon">search</span>
                                <span class="material-icons-round header-icon">menu</span>
                            </div>
                        </div>
                        <div class="chat-screen" id="chatScreen"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="control-panel">
            <div class="panel-body">
                <button class="btn-main btn-generate" onclick="generateStepByStepGIF()" style="padding:15px; margin-bottom:10px;">
                    <span class="material-icons-round">movie_creation</span> GIF ÎßåÎì§Í∏∞
                </button>

                <div class="card">
                    <div class="section-header">
                        <div class="section-label"><span class="material-icons-round">tune</span>Í∏∞Î≥∏ ÏÑ§Ï†ï</div>
                    </div>
                    
                    <input type="text" id="roomNameInput" class="input-field" value="ÌÅ¨Î¶¨Ïä§ÎßàÏä§ ÌååÌã∞Î∞© üéÑ" oninput="setRoomName(this.value)" placeholder="Ï±ÑÌåÖÎ∞© Ïù¥Î¶Ñ">
                    
                    <div class="color-row">
                        <div class="color-group">
                            <label>ÏÉÅÎã®Î∞î</label>
                            <div class="color-input-box"><input type="color" oninput="setHeaderColor(this.value)" value="#d32f2f"></div>
                        </div>
                        <div class="color-group">
                            <label>ÎßêÌíçÏÑ† A</label>
                            <div class="color-input-box"><input type="color" oninput="setBubbleColorA(this.value)" value="#d32f2f"></div>
                        </div>
                        <div class="color-group">
                            <label>ÎßêÌíçÏÑ† B</label>
                            <div class="color-input-box"><input type="color" oninput="setBubbleColorB(this.value)" value="#2e7d32"></div>
                        </div>
                    </div>

                    <div style="margin-top:15px; display: flex; gap: 8px;">
                        <div style="width: 40px; height: 35px; border-radius: 6px; overflow: hidden; border: 1px solid #ddd; position:relative;">
                            <input type="color" oninput="setBgColor(this.value)" value="#1c1c1c" style="width: 150%; height: 150%; position: absolute; top: -5px; left: -5px; cursor: pointer;">
                        </div>
                        <div class="upload-btn-wrapper" style="flex:1;">
                            <label class="btn-file"><span class="material-icons-round">image</span> Î∞∞Í≤Ω ÏÇ¨ÏßÑ Î≥ÄÍ≤Ω
                                <input type="file" accept="image/*" onchange="openCropper(this, 'bg')">
                            </label>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="section-label"><span class="material-icons-round">group</span>ÌîÑÎ°úÌïÑ</div>
                    <div class="profile-grid">
                        <div class="profile-config">
                            <div class="profile-preview-circle"><img id="previewA" style="display:none;"><span id="iconA" class="material-icons-round">person</span></div>
                            <input type="text" id="nameA" class="input-field" value="ÏÇ∞ÌÉÄ" style="text-align:center; padding: 5px;">
                            <div class="upload-btn-wrapper"><label class="btn-file" style="font-size:11px; padding:4px;">ÏÇ¨ÏßÑ<input type="file" accept="image/*" onchange="openCropper(this, 'A')"></label></div>
                        </div>
                        <div class="profile-config">
                            <div class="profile-preview-circle"><img id="previewB" style="display:none;"><span id="iconB" class="material-icons-round">person</span></div>
                            <input type="text" id="nameB" class="input-field" value="Î£®ÎèåÌîÑ" style="text-align:center; padding: 5px;">
                            <div class="upload-btn-wrapper"><label class="btn-file" style="font-size:11px; padding:4px;">ÏÇ¨ÏßÑ<input type="file" accept="image/*" onchange="openCropper(this, 'B')"></label></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="section-label"><span class="material-icons-round">chat</span>ÎåÄÌôî ÏûÖÎ†•</div>
                    <div class="toggle-group">
                        <button class="toggle-item active red-theme" id="btnSideA" onclick="setSide('left')">A (Left)</button>
                        <button class="toggle-item" id="btnSideB" onclick="setSide('right')">B (Right)</button>
                    </div>
                    <div class="toggle-group">
                        <button class="toggle-item active" id="btnTypeMsg" onclick="setType('text')">ÎßêÌíçÏÑ†</button>
                        <button class="toggle-item" id="btnTypeGift" onclick="setType('gift')">ÏÑ†Î¨ºÏπ¥Îìú</button>
                    </div>

                    <div id="textMode">
                        <textarea id="inputMsg" class="input-field" rows="2" placeholder="Î©îÏÑ∏ÏßÄ ÏûÖÎ†•..."></textarea>
                    </div>

                    <div id="giftMode" style="display:none; flex-direction: column; gap: 6px;">
                        <input type="text" id="giftHeader" class="input-field" placeholder="Ìó§Îçî Î¨∏Íµ¨">
                        <input type="text" id="giftTitle" class="input-field" placeholder="ÏÉÅÌíàÎ™Ö">
                        <textarea id="giftDesc" class="input-field" rows="2" placeholder="ÏÑ§Î™Ö"></textarea>
                        <div class="upload-btn-wrapper">
                            <label class="btn-file">ÏÑ†Î¨º Ïù¥ÎØ∏ÏßÄ<input type="file" id="giftFileInput" accept="image/*" onchange="openCropper(this, 'gift')"></label>
                        </div>
                        <div id="giftPreviewArea">
                            <img id="giftPreviewImg" src="" alt="ÎØ∏Î¶¨Î≥¥Í∏∞">
                        </div>
                    </div>

                    <button class="btn-main" onclick="addContent()" style="margin-top:10px;"><span class="material-icons-round">add</span> Ï∂îÍ∞ÄÌïòÍ∏∞</button>
                    <button onclick="document.getElementById('chatScreen').innerHTML=''" style="width:100%; padding:10px; border:none; background:transparent; color:#999; cursor:pointer; font-size:12px;">Ï†ÑÏ≤¥ ÏÇ≠Ï†ú</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Ï†ÑÏó≠ Î≥ÄÏàò ÏÑ§Ï†ï ---
        let currentSide = 'left'; 
        let currentType = 'text';
        let imgDataA = null; 
        let imgDataB = null;

        // --- ÌÅ¨Î°≠Ìçº Í¥ÄÎ†® Î≥ÄÏàò ---
        let cropperImage = new Image();
        let cropperCanvas = null;
        let cropperCtx = null;
        let currentScale = 1;
        let currentRotation = 0;
        let imgPosX = 0, imgPosY = 0;
        let isDragging = false;
        let startX, startY;
        let currentCropType = null; 
        let targetAspectRatio = 1; 

        // --- 1. ÌÅ¨Î°≠Ìçº Ïó¥Í∏∞ Ìï®Ïàò ---
        function openCropper(input, type) {
            const file = input.files[0];
            if (!file) return;
            
            currentCropType = type;
            
            if (type === 'bg') {
                targetAspectRatio = 9 / 16; 
            } else if (type === 'gift') {
                targetAspectRatio = 220 / 130; 
            } else {
                targetAspectRatio = 1; 
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                cropperImage.src = e.target.result;
                cropperImage.onload = function() {
                    document.getElementById('cropper-modal').classList.add('show');
                    initCanvas();
                }
            }
            reader.readAsDataURL(file);
            input.value = ''; 
        }

        // --- 2. Ï∫îÎ≤ÑÏä§ Ï¥àÍ∏∞Ìôî (ÌôîÏßà Í∞úÏÑ† Ï†ÅÏö©) ---
        function initCanvas() {
            cropperCanvas = document.getElementById('cropper-canvas');
            cropperCtx = cropperCanvas.getContext('2d');
            const container = document.getElementById('canvasContainer');
            
            // Î≥¥Ïó¨ÏßÄÎäî ÌÅ¨Í∏∞ Í≥ÑÏÇ∞
            const maxW = 320; 
            const maxH = 450; 
            
            let finalW = maxW;
            let finalH = maxW / targetAspectRatio;

            if (finalH > maxH) {
                finalH = maxH;
                finalW = finalH * targetAspectRatio;
            }

            // [Ï§ëÏöî] Ïª®ÌÖåÏù¥ÎÑàÎäî ÌôîÎ©¥ ÌÅ¨Í∏∞Î°ú ÏÑ§Ï†ï
            container.style.width = finalW + 'px';
            container.style.height = finalH + 'px';

            // [Ï§ëÏöî] Ï∫îÎ≤ÑÏä§Îäî Ïã§Ï†ú Ìï¥ÏÉÅÎèÑÎ•º 2Î∞∞Î°ú ÏÑ§Ï†ïÌïòÏó¨ Í≥†ÌôîÏßà Ï†ÄÏû•
            const dpr = 2; 
            cropperCanvas.width = finalW * dpr;
            cropperCanvas.height = finalH * dpr;
            
            // Ïª®ÌÖçÏä§Ìä∏ Ïä§ÏºÄÏùº Ï°∞Ï†ï (Ï¢åÌëú Í≥ÑÏÇ∞ÏùÄ ÌôîÎ©¥ ÌÅ¨Í∏∞ Í∏∞Ï§Ä Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö© Í∞ÄÎä•)
            cropperCtx.scale(dpr, dpr);

            currentScale = 1; 
            currentRotation = 0;
            imgPosX = finalW / 2; 
            imgPosY = finalH / 2;
            document.getElementById('crop-zoom').value = 1;
            
            drawCanvas();


            container.onmousedown = startDrag;
            container.onmousemove = drag;
            container.onmouseup = endDrag;
            container.onmouseleave = endDrag;
            
            container.ontouchstart = (e) => { 
                const touch = e.touches[0]; 
                startDrag({ clientX: touch.clientX, clientY: touch.clientY }); 
            };
            container.ontouchmove = (e) => { 
                if(!isDragging) return; 
                e.preventDefault(); 
                const touch = e.touches[0]; 
                drag({ clientX: touch.clientX, clientY: touch.clientY }); 
            };
            container.ontouchend = endDrag;
        }

        function drawCanvas() {
            if(!cropperCtx) return;
            // Ï∫îÎ≤ÑÏä§ ÌÅ¥Î¶¨Ïñ¥ (Ïä§ÏºÄÏùºÎêú ÌÅ¨Í∏∞ Í≥†Î†§)
            cropperCtx.clearRect(0,0, cropperCanvas.width / 2, cropperCanvas.height / 2); 
            // ÏïàÏ†ÑÌïòÍ≤å Ï†ÑÏ≤¥ ÏßÄÏö∞Í∏∞
            cropperCtx.save();
            cropperCtx.setTransform(1, 0, 0, 1, 0, 0);
            cropperCtx.clearRect(0, 0, cropperCanvas.width, cropperCanvas.height);
            cropperCtx.restore();
            
            cropperCtx.save();
            cropperCtx.translate(imgPosX, imgPosY);
            cropperCtx.rotate(currentRotation * Math.PI / 180);
            cropperCtx.scale(currentScale, currentScale);
            cropperCtx.drawImage(cropperImage, -cropperImage.width/2, -cropperImage.height/2);
            cropperCtx.restore();
        }

        // --- 3. ÎìúÎûòÍ∑∏ Î∞è Ï°∞Ïûë Î°úÏßÅ ---
        function startDrag(e) { isDragging = true; startX = e.clientX; startY = e.clientY; }
        
        function drag(e) {
            if(!isDragging) return;
            const dx = e.clientX - startX; 
            const dy = e.clientY - startY;
            imgPosX += dx; 
            imgPosY += dy;
            startX = e.clientX; 
            startY = e.clientY;
            drawCanvas();
        }
        
        function endDrag() { isDragging = false; }

        document.getElementById('crop-zoom').addEventListener('input', function(e) {
            currentScale = parseFloat(e.target.value); 
            drawCanvas();
        });

        function rotateImage(deg) {
            currentRotation = (currentRotation + deg) % 360; 
            drawCanvas();
        }

        // --- 4. Ï†ÅÏö©(Apply) Î∞è Îã´Í∏∞ ---
        function closeCropper() {
            document.getElementById('cropper-modal').classList.remove('show');
            currentCropType = null;
        }

        function applyCrop() {
            const dataUrl = cropperCanvas.toDataURL('image/png');

            if (currentCropType === 'bg') {
                const s = document.getElementById('chatScreen');
                s.style.backgroundImage = `url(${dataUrl})`;
                s.style.backgroundColor = '#fff';
            } 
            else if (currentCropType === 'A') {
                imgDataA = dataUrl;
                document.getElementById('previewA').src = dataUrl;
                document.getElementById('previewA').style.display = 'block';
                document.getElementById('iconA').style.display = 'none';
            }
            else if (currentCropType === 'B') {
                imgDataB = dataUrl;
                document.getElementById('previewB').src = dataUrl;
                document.getElementById('previewB').style.display = 'block';
                document.getElementById('iconB').style.display = 'none';
            }
            else if (currentCropType === 'gift') {
                const previewArea = document.getElementById('giftPreviewArea');
                const previewImg = document.getElementById('giftPreviewImg');
                previewImg.src = dataUrl;
                previewArea.style.display = 'block';
                previewImg.dataset.fullSrc = dataUrl;
            }

            closeCropper();
        }

        // --- Í∏∞Ï°¥ Ï±ÑÌåÖÏï± Î°úÏßÅ ---
        function setRoomName(name) { document.getElementById('roomNameDisplay').innerText = name; }
        function setHeaderColor(color) { document.documentElement.style.setProperty('--header-color', color); }
        function setBubbleColorA(color) { document.documentElement.style.setProperty('--primary-color', color); }
        function setBubbleColorB(color) { document.documentElement.style.setProperty('--secondary-color', color); }
        
        function setBgColor(val) { 
            document.getElementById('chatScreen').style.backgroundImage = 'none'; 
            document.getElementById('chatScreen').style.backgroundColor = val; 
        }

        function setSide(side) { 
            currentSide = side; 
            document.getElementById('btnSideA').className = `toggle-item ${side==='left'?'active red-theme':''}`; 
            document.getElementById('btnSideB').className = `toggle-item ${side==='right'?'active green-theme':''}`; 
            
            const h = document.getElementById('giftHeader');
            const defaultText = side === 'left' ? 'ÏÇ∞ÌÉÄÏùò ÏÑ†Î¨º' : 'Î£®ÎèåÌîÑÏùò ÏÑ†Î¨º';
            if(!h.value || h.value === 'ÏÇ∞ÌÉÄÏùò ÏÑ†Î¨º' || h.value === 'Î£®ÎèåÌîÑÏùò ÏÑ†Î¨º') h.value = defaultText; 
        }

        function setType(type) { 
            currentType = type; 
            document.getElementById('btnTypeMsg').className = `toggle-item ${type==='text'?'active':''}`; 
            document.getElementById('btnTypeGift').className = `toggle-item ${type==='gift'?'active':''}`; 
            document.getElementById('textMode').style.display = type==='text'?'block':'none'; 
            document.getElementById('giftMode').style.display = type==='gift'?'flex':'none'; 
        }

        function addContent() {
            const screen = document.getElementById('chatScreen');
            const isLeft = (currentSide === 'left');
            const name = isLeft ? document.getElementById('nameA').value : document.getElementById('nameB').value;
            const profileSrc = isLeft ? imgDataA : imgDataB; 
            
            let profileHtml = profileSrc ? `<div class="profile-img-s"><img src="${profileSrc}"></div>` : `<div class="profile-img-s" style="display:flex; align-items:center; justify-content:center;"><span class="material-icons-round" style="color:#666; font-size:20px;">person</span></div>`;
            const wrapper = document.createElement('div');
            wrapper.className = `chat-row ${currentSide}`;

            const deleteBtn = `<div class="delete-btn" onclick="this.closest('.chat-row').remove()">‚úï</div>`;

            let contentHtml = '';
            if (currentType === 'text') {
                const msg = document.getElementById('inputMsg').value;
                if(!msg) return;
                contentHtml = `<div class="bubble">${msg.replace(/\n/g, '<br>')}${deleteBtn}</div>`;
                document.getElementById('inputMsg').value = ''; 
                document.getElementById('inputMsg').focus();
            } else {
                const h = document.getElementById('giftHeader').value;
                const t = document.getElementById('giftTitle').value;
                const d = document.getElementById('giftDesc').value;
                const previewImg = document.getElementById('giftPreviewImg');
                const imgSrc = previewImg.dataset.fullSrc || 'https://via.placeholder.com/300x200/eee/999?text=GIFT';
                const theme = isLeft ? '' : 'green-theme';
                
                contentHtml = `<div class="gift-card ${theme}"><div class="gift-header">${h}</div><div class="gift-img-area"><img src="${imgSrc}"></div><div class="gift-content"><div class="gift-title">${t}</div><div class="gift-desc">${d.replace(/\n/g, '<br>')}</div></div>${deleteBtn}</div>`;
                
                document.getElementById('giftTitle').value=''; 
                document.getElementById('giftDesc').value=''; 
                document.getElementById('giftFileInput').value=''; 
                document.getElementById('giftPreviewArea').style.display = 'none'; 
                previewImg.src = ''; 
                delete previewImg.dataset.fullSrc;
                
                setSide(currentSide); 
            }
            if(contentHtml) appendChat(wrapper, name, profileHtml, contentHtml);
        }

        function appendChat(wrapper, name, profileHtml, contentHtml) {
            wrapper.innerHTML = `<div class="profile-area">${profileHtml}<div class="profile-name-s">${name}</div></div>${contentHtml}`;
            const screen = document.getElementById('chatScreen');
            screen.appendChild(wrapper);
            screen.scrollTop = screen.scrollHeight; 
        }

        document.getElementById('inputMsg').addEventListener('keypress', function(e){ if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addContent(); }});
        
        setType('text');
        setSide('left');

        function showModal() { document.getElementById('resultModalOverlay').style.display = 'flex'; }
        function closeModal() { document.getElementById('resultModalOverlay').style.display = 'none'; }

        // GIF ÏÉùÏÑ± Î°úÏßÅ (Î∞∞Í≤Ω Ìà¨Î™ÖÌôî + Í≥†ÌôîÏßà ÏàòÏ†ï + ÌïëÌÅ¨ÏÉâ Ï†úÍ±∞)
        const workerBlob = new Blob([`importScripts('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');`], { type: 'application/javascript' });
        const workerUrl = URL.createObjectURL(workerBlob);

        async function generateStepByStepGIF() {
            const screen = document.getElementById('chatScreen');
            const target = document.getElementById('captureTarget');
            const rows = document.querySelectorAll('.chat-row');
            
            if(rows.length === 0) return alert('ÎåÄÌôîÎ•º Î®ºÏ†Ä ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');

            document.getElementById('loadingOverlay').style.display = 'flex';
            target.classList.add('capturing-mode');

            // [Ï§ëÏöî] Ï∫°Ï≤ò Ìï¥ÏÉÅÎèÑ 2Î∞∞ ÏÑ§Ï†ï
            const scale = 2; 

            // [ÏàòÏ†ï] ÌïëÌÅ¨ÏÉâ Ï†úÍ±∞Î•º ÏúÑÌï¥ backgroundColor: null ÏÇ¨Ïö©
            const gif = new GIF({
                workers: 4, 
                quality: 10, 
                width: target.offsetWidth * scale,  
                height: target.offsetHeight * scale,
                workerScript: workerUrl, 
                background: null, // Î∞∞Í≤Ω ÏóÜÏùå
                transparent: 0x000000 // 0x000000(Ìà¨Î™Ö)ÏúºÎ°ú Ï≤òÎ¶¨
            });

            const captureFrame = async (delay) => {
                try {
                    const canvas = await html2canvas(target, {
                        scale: scale, 
                        useCORS: true, 
                        allowTaint: true, 
                        logging: false,
                        backgroundColor: null // [ÏàòÏ†ï] Î∞∞Í≤ΩÏùÑ Ìà¨Î™Ö(null)ÏúºÎ°ú Ï∫°Ï≤ò
                    });
                    gif.addFrame(canvas, {copy: true, delay: delay});
                } catch (e) {
                    console.error("Frame Capture Error:", e);
                    throw e; 
                }
            };

            // Ï¥àÍ∏∞Ìôî: Ïä§ÌÅ¨Î°§ Î∞è ÌëúÏãú ÏÑ§Ï†ï
            rows.forEach(r => r.style.display = 'none');
            screen.scrollTop = 0; 

            try {
                // 1. Îπà ÌôîÎ©¥ Ï∫°Ï≤ò
                await captureFrame(300); 
                
                // 2. ÎåÄÌôî ÌïòÎÇòÏî© Îì±Ïû•ÌïòÎ©∞ Ï∫°Ï≤ò
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    row.style.display = 'flex'; 
                    screen.scrollTop = screen.scrollHeight; // ÏûêÎèô Ïä§ÌÅ¨Î°§
                    await new Promise(r => setTimeout(r, 100)); // Î†åÎçîÎßÅ ÎåÄÍ∏∞
                    await captureFrame(600); 
                }
                
                // 3. ÎßàÏßÄÎßâ Ïû•Î©¥ Í∏∏Í≤å Ï∫°Ï≤ò
                await captureFrame(1000);

                gif.on('finished', function(blob) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `christmas_story_${Date.now()}.gif`;
                    link.click();
                    
                    target.classList.remove('capturing-mode');
                    document.getElementById('loadingOverlay').style.display = 'none';
                    showModal();
                    rows.forEach(r => r.style.display = 'flex');
                });
                gif.render();

            } catch (err) {
                console.error(err);
                alert('Ïò§Î•ò Î∞úÏÉù: ' + err.message);
                target.classList.remove('capturing-mode');
                document.getElementById('loadingOverlay').style.display = 'none';
                rows.forEach(r => r.style.display = 'flex');
            }
        }
        
        window.onload = function() {
            document.getElementById('chatScreen').scrollTop = 0;
        }
    </script>
</body>
</html>

