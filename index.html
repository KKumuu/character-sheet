<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>누덕누덕 설정틀</title>
    <!-- Paperlogy Font (All Subsets) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fonts-archive/Paperlogy/subsets/Paperlogy-dynamic-subset.css" type="text/css"/>
    
    <link rel="icon" type="image/png" href="ico.png">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Pixelify+Sans:wght@400;700&display=swap" rel="stylesheet">
    <!-- Pretendard (Backup) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>

    <style>
        /* --- [1] 통합 CSS (기존 style.css + 다인용 CSS) --- */
        :root {
            --bg-color: #eef2f5; 
            --p1-text: #333; --p2-text: #333; 
            --sub-text-color: #888;
            --frame-bg: #ffffff; --frame-border: #ffffff;
            --component-bg: white; --input-bg: white; --input-border: #eee;
            --shadow-color: rgba(0,0,0,0.08);
            --accent-color: #444;
            --sidebar-bg: #fff; --sidebar-icon: #555;
            --sticker-border: #2196F3;
            --pair-name-color: #333;
            --pair-font: 'Dancing Script', cursive;
            --glass-bg: rgba(255, 255, 255, 0.15); 
            --glass-border: rgba(255,255,255,0.2);
            --phone-ui-text: white;
            
            /* Multiplayer Variables */
            --mp-card-bg: #fff;
            --mp-text-color: #333;
            --mp-sub-text: #888;
        }

        body.dark-mode {
            --bg-color: #222; 
            --sub-text-color: #aaa;
            --frame-bg: #2b2b2b; --frame-border: #444;
            --component-bg: #444; --input-bg: #555; --input-border: #666;
            --shadow-color: rgba(0,0,0,0.5);
            --accent-color: #eee;
            --sidebar-bg: #333; --sidebar-icon: #eee;
            --glass-bg: rgba(0, 0, 0, 0.3); 
            --glass-border: rgba(255,255,255,0.05);
            --phone-ui-text: #eee; 

            /* Multiplayer Dark Mode */
            --mp-card-bg: #444;
            --mp-text-color: #eee;
            --mp-sub-text: #aaa;
        }

        /* 폰트 강제 적용 (Paperlogy 우선) */
        * { box-sizing: border-box; font-family: 'Paperlogy', 'Pretendard', sans-serif !important; outline: none; }

        .material-icons, .material-icons-outlined, img { user-select: none; -webkit-user-drag: none; }
        .font-style-1 { font-family: 'Dancing Script', cursive !important; }
        .font-style-2 { font-family: 'Paperlogy', sans-serif !important; font-weight:800; text-transform:uppercase; letter-spacing:2px; }
        .font-style-3 { font-family: 'Pixelify Sans', sans-serif !important; }

        body { background-color: #333; margin: 0; padding: 20px; display: flex; min-height: 100vh; justify-content: center; align-items: center; }
        .no-select { user-select: none; cursor: default; }

        /* 기존 사이드바 스타일 */
        .sidebar { position: fixed; top: 50%; transform: translateY(-50%); background: var(--sidebar-bg); border-radius: 12px; padding: 10px 8px; display: flex; flex-direction: column; gap: 8px; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; transition: opacity 0.3s;}
        .left-sidebar { left: 15px; } .right-sidebar { right: 15px; }
        .menu-item { width: 44px; height: 44px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--sidebar-icon); transition: 0.2s; position: relative; }
        .menu-item:hover { background: rgba(0,0,0,0.05); transform: scale(1.05); }
        .menu-item input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; left:0; top:0; }
        .menu-item.active-link { background-color: #e0f7fa; color: #00bcd4; border: 1px solid #00bcd4; }
        
        /* 버튼 툴팁 */
        .menu-item::after, .save-btn-round::after, .reset-btn-style::after, .round-btn::after {
            content: attr(data-title); position: absolute; left: 60px; top: 50%; transform: translateY(-50%); background: #333; color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; white-space: nowrap; opacity: 0; pointer-events: none; transition: 0.2s; visibility: hidden; z-index: 1100; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .right-sidebar .menu-item::after, .reset-btn-style::after { left: auto; right: 60px; }
        .menu-item:hover::after, .save-btn-round:hover::after, .reset-btn-style:hover::after, .round-btn:hover::after { opacity: 1; visibility: visible; }

        .divider { width: 24px; height: 1px; background: #ddd; margin: 4px 0; }
        .save-btn-round { background: var(--accent-color); border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); width: 44px; height: 44px; border-radius: 10px; cursor: pointer; display:flex; align-items:center; justify-content:center; color:white; transition:0.2s;}
        .save-btn-round:hover { transform: scale(1.05); }
        
        .bottom-right-controls { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 1000; align-items: center; transition: opacity 0.3s; }
        .top-right-controls { position: fixed; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 1000; transition: opacity 0.3s; }
        
        .round-btn { 
            width: 50px; height: 50px; 
            background: #fff; color: #555; 
            border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: 0.2s; position: relative; 
        }
        .round-btn:hover { transform: scale(1.1); background: rgba(0,0,0,0.05); }

        /* 모달 스타일 */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 300px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .emoji-content { width: 400px; padding: 0; border-radius: 10px; overflow: hidden; background: transparent; box-shadow: none;}
        emoji-picker { width: 100%; height: 400px; border-radius: 10px; --background: var(--component-bg); --border-color: var(--input-border); }
        .modal-btns { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .modal-btns button { border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        /* Cropper */
        .cropper-content { width: 90%; max-width: 500px; height: auto; max-height: 90vh; display: flex; flex-direction: column; }
        .canvas-container { width: 100%; height: 350px; background: #222; margin-bottom: 15px; overflow: hidden; border-radius: 10px; border: 1px solid #444; display: flex; justify-content: center; align-items: center; position: relative; }
        #cropper-canvas { max-width: 95%; max-height: 95%; border: 2px solid #00d2ff; box-shadow: 0 0 15px rgba(0, 210, 255, 0.3); background-color: white; }
        .cropper-controls { display: flex; align-items: center; gap: 10px; justify-content: center; margin-bottom: 20px; }
        
        /* ============================ */
        /* === 기존 Sheet Design === */
        /* ============================ */
        .auto-shrink { display: block; overflow: hidden; white-space: nowrap; width: 100%; }
        #pair-name-container { width: 600px; height: 70px; text-align: center; overflow: hidden; }
        .sheet { 
            background-color: var(--bg-color); background-size: cover; background-position: center; 
            padding: 80px 60px 40px 60px; border-radius: 20px; transition: 0.3s; 
            display: flex; gap: 15px; 
            position: relative; 
        }
        .sheet.mode-1, .sheet.mode-2 { width: auto; justify-content: center; }

        .pair-name { font-size: 50px; color: var(--pair-name-color); text-shadow: 0 2px 4px rgba(0,0,0,0.1); white-space: nowrap; font-family: var(--pair-font); cursor: text; transition: 0.2s; }
        #pair-name-wrapper { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; gap: 0px; z-index: 20; }
        
        .phone-frame { background-color: var(--frame-bg); border-radius: 30px; width: 290px; height: 660px; flex-shrink: 0; display: flex; flex-direction: column; position: relative; overflow: hidden; border: 8px solid var(--frame-border); box-shadow: 5px 8px 25px rgba(0,0,0,0.1); z-index: 10; }
        
        /* ... (중략: 기존 스타일 유지) ... */
        .glass-bar { background: var(--glass-bg); backdrop-filter: blur(8px); border-top: 1px solid var(--glass-border); border-bottom: 1px solid var(--glass-border); color: var(--phone-ui-text); text-shadow: 0 1px 2px rgba(0,0,0,0.3); position: absolute; width: 100%; z-index: 10; pointer-events: none; }
        .status-bar { top: 0; height: 50px; display: flex; justify-content: space-between; padding: 0 20px; align-items: center; font-size: 14px; }
        .dock-bar { bottom: 0; height: 70px; display: flex; justify-content: space-evenly; align-items: center; padding-bottom: 5px; }
        .dock-item { display: flex; flex-direction: column; align-items: center; gap: 2px; color: var(--phone-ui-text); width: 60px; cursor: default; text-shadow: none; }
        .music-player { position: absolute; bottom: 85px; left: 15px; right: 15px; padding: 12px; border-radius: 16px; display: flex; gap: 12px; align-items: center; color: white; z-index: 5; cursor: default; }
        .glass-effect { background: rgba(255,255,255,0.15); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.2); }
        .album-art { width: 55px; height: 55px; border-radius: 10px; background: rgba(255,255,255,0.1); position: relative; overflow: hidden; cursor: pointer; flex-shrink: 0; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; }
        .album-art input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .info-frame { display: flex; flex-direction: column; width: 290px; padding-top: 0; height: 660px; }
        
        .bubble { width: fit-content; max-width: 240px; min-width: 40px; min-height: 30px; height: auto; background: var(--component-bg); color: #333; padding: 8px 18px; border-radius: 16px; font-size: 14px; box-shadow: 2px 2px 8px var(--shadow-color); position: relative; border-top-left-radius: 0; display: flex; align-items: center; }
        .bubble::after { content: ''; position: absolute; top: 0; left: -8px; border-width: 0 10px 10px 0; border-style: solid; border-color: transparent var(--component-bg) transparent transparent; }
        
        .sub-img { width: 130px; height: 130px; background: var(--input-bg); border-radius: 16px; position: relative; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; background-size: cover; background-position: center; border: 1px solid var(--input-border); box-shadow: 2px 2px 5px rgba(0,0,0,0.05); }
        .sub-img input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        .profile-set { display: flex; gap: 30px; transition: all 0.5s ease; }
        #p2-set { opacity: 0; width: 0; overflow: hidden; transition: opacity 0.5s ease, width 0.5s ease; }
        .mode-2 #p2-set { opacity: 1; width: 610px; }

        /* ============================ */
        /* === NEW: Multiplayer CSS === */
        /* ============================ */
        
        /* 모드 전환 버튼 */
        .mode-switch-btn {
            position: fixed; top: 20px; left: 20px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: #eee;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 30px;
            cursor: pointer;
            font-size: 13px; font-weight: bold;
            transition: 0.3s;
            z-index: 2500;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 5px;
        }
        .mode-switch-btn:hover { background: rgba(255, 255, 255, 0.4); transform: scale(1.05); color: white;}

        /* 멀티플레이어 모드일 때 기존 요소 숨김 */
        body.multiplayer-active .sidebar,
        body.multiplayer-active .top-right-controls,
        body.multiplayer-active .bottom-right-controls,
        body.multiplayer-active .top-notice {
            display: none !important;
        }
        
        /* 멀티플레이어 전용 래퍼 */
        #mp-wrapper { display: none; align-items: center; gap: 30px; }
        #mp-wrapper.active { display: flex; }

        /* 멀티플레이어 컨테이너 (저장 대상) */
        #multiplayer-container {
            display: flex;
            background-color: var(--bg-color);
            padding: 60px;
            border-radius: 20px;
            align-items: flex-start;
            gap: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 800px;
            flex-wrap: nowrap;
        }

        /* 멀티플레이어 카드 디자인 */
        .mp-card {
            width: 320px;
            min-height: 700px;
            background: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex-shrink: 0;
            padding: 10px;
            transition: 0.3s;
        }

        .mp-header { width: 100%; display: flex; justify-content: center; align-items: center; margin-bottom: 15px; position: relative; flex-shrink: 0; height: 60px; }

        .mp-number-badge {
            position: absolute; left: 0; top: 10px; width: 40px; height: 40px;
            background-color: #ddd; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 18px; color: #333;
            cursor: pointer; overflow: hidden; flex-shrink: 0;
            border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .mp-number-badge input[type="color"] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .mp-number-text { z-index: 2; pointer-events: none; }

        .mp-titles { text-align: center; display: flex; flex-direction: column; align-items: center; width: 100%; flex-shrink: 0; }
        .mp-title-main {
            font-size: 32px; font-weight: 900; color: var(--mp-text-color);
            margin-bottom: 0; min-width: 100px; max-width: 200px;
            white-space: nowrap; overflow: hidden;
            height: 38px; line-height: 38px; flex-shrink: 0;
        }
        .mp-title-sub {
            font-size: 14px; font-weight: 300; color: var(--mp-text-color);
            letter-spacing: 2px; text-transform: uppercase;
            height: 20px; line-height: 20px; flex-shrink: 0;
        }

        .mp-image-area {
            width: 100%; height: 420px; background-color: #dcdcdc;
            margin-bottom: 20px; position: relative; cursor: pointer;
            overflow: hidden; display: flex; align-items: center; justify-content: center;
            background-size: cover; background-position: center;
            transition: 0.2s; flex-shrink: 0; border-radius: 4px;
        }
        .mp-image-area:hover { filter: brightness(0.95); }
        .mp-image-area input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }
        .mp-placeholder { text-align: center; color: #888; pointer-events: none; }

        .mp-info { width: 100%; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
        .mp-name-kor {
            font-size: 36px; font-weight: 500; color: var(--mp-text-color);
            text-align: center; margin-bottom: 10px; width: 100%; max-width: 280px;
            white-space: nowrap; overflow: hidden; height: 45px; line-height: 45px; flex-shrink: 0;
        }
        .mp-palette { display: flex; gap: 15px; justify-content: center; margin-bottom: 10px; flex-shrink: 0; }
        .mp-color-dot { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .mp-dot { width: 30px; height: 30px; border-radius: 50%; background: #ffffff; position: relative; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); }
        .mp-dot input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .mp-dot-label { font-size: 10px; color: var(--mp-sub-text); text-transform: uppercase; font-weight: bold; }

        .mp-stats {
            font-size: 18px; color: var(--mp-text-color); text-align: center;
            margin-bottom: 20px; opacity: 0.8; width: 100%;
            white-space: nowrap; overflow: hidden; height: 28px; line-height: 28px; flex-shrink: 0;
        }

        .mp-desc-box {
            width: 100%; min-height: 100px; background: var(--mp-card-bg);
            border-radius: 4px; padding: 15px; font-size: 14px;
            color: var(--mp-text-color); line-height: 1.6; white-space: pre-wrap;
            box-shadow: 0 2px 10px var(--shadow-color); border: 1px solid var(--input-border);
            flex-shrink: 1;
        }

        .add-card-btn {
            width: 60px; height: 60px; border-radius: 50%;
            background: rgba(255,255,255,0.2); border: 2px dashed #999;
            color: #ccc; display: flex; align-items: center; justify-content: center;
            cursor: pointer; flex-shrink: 0; transition: 0.2s;
        }
        .add-card-btn:hover { background: rgba(255,255,255,0.4); transform: scale(1.1); color: white; border-color: white;}
        
        .delete-card-btn {
            position: absolute; top: -10px; right: -10px;
            background: #ff4d4d; color: white; width: 24px; height: 24px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; opacity: 0; transition: 0.2s; z-index: 100;
        }
        .mp-card:hover .delete-card-btn { opacity: 1; }

        /* 저장 시 숨김 처리 */
        body.capturing .hide-on-save, body.capturing .mode-switch-btn { display: none !important; }

        /* Helper for contenteditable */
        [contenteditable]:empty:before { content: attr(data-placeholder); color: #bbb; display: block; }
        
        /* UI Hidden mode */
        body.ui-hidden nav, body.ui-hidden .top-right-controls, body.ui-hidden .top-notice, body.ui-hidden .bottom-right-controls, body.ui-hidden .mode-switch-btn { visibility: hidden !important; pointer-events: none; }
        body.ui-hidden .ui-toggle-btn { visibility: visible !important; pointer-events: auto; }
    </style>
</head>
<body>

    <!-- [2] 모드 전환 버튼 -->
    <div class="mode-switch-btn hide-on-save" onclick="toggleMultiplayerMode()">
        <span class="material-icons">people_alt</span>
        <span id="mode-text">다인용 모드로 전환</span>
    </div>

    <!-- Top Notice (Original) -->
    <div class="top-notice hide-on-save">
        <p>모든 텍스트 칸은 수정 가능합니다.</p>
        <p>더미텍스트는 저장시 출력되지 않습니다.</p>
    </div>
    
    <!-- Top Right Controls (Load/Save Slots) -->
    <div class="top-right-controls hide-on-save">
        <div class="round-btn" onclick="openSlotModal('save')" data-title="임시 저장">
            <span class="material-icons">save</span>
        </div>
        <div class="round-btn" onclick="openSlotModal('load')" data-title="불러오기">
            <span class="material-icons">folder_open</span>
        </div>
    </div>

    <!-- Bottom Right Controls (UI Toggle, Reset) -->
    <div class="bottom-right-controls hide-on-save">
        <div class="round-btn ui-toggle-btn" onclick="toggleUI()" data-title="UI 끄기/켜기">
            <span class="material-icons" id="ui-icon">visibility</span>
        </div>
        <div class="round-btn reset-btn-style" onclick="showResetModal()" data-title="초기화">
            <span class="material-icons">refresh</span>
        </div>
    </div>

    <!-- Left Sidebar (Mode, Colors) -->
    <nav class="sidebar left-sidebar hide-on-save">
        <div class="menu-group">
            <div class="menu-item" data-title="1인 모드" onclick="setMode(1)"><span class="material-icons">person</span></div>
            <div class="menu-item" data-title="2인 모드" onclick="setMode(2)"><span class="material-icons">people</span></div>
            <div class="menu-item" id="btn-minimal" data-title="미니멀 모드" onclick="toggleMinimalMode()"><span class="material-icons">crop_portrait</span></div>
        </div>
        <div class="divider"></div>
        <div class="menu-group">
            <div class="menu-item" data-title="전체 배경 색상"><span class="material-icons">format_paint</span><input type="color" value="#eef2f5" oninput="changeSheetColor(this.value)"></div>
            <div class="menu-item" data-title="배경 사진 넣기"><label for="bg-file-upload"><span class="material-icons">image</span></label><input type="file" id="bg-file-upload" accept="image/*" onchange="loadBackgroundImage(event)"></div>
             <div class="menu-item" data-title="스티커 추가"><label for="sticker-upload"><span class="material-icons">star</span></label><input type="file" id="sticker-upload" accept="image/*" onchange="addSticker(event)"></div>
        </div>
        <div class="divider"></div>
        <div class="menu-group">
            <div class="menu-item" data-title="P1-P2 색상 연동" onclick="toggleColorLink(this)"><span class="material-icons">link</span></div>
            <div class="menu-item" data-title="P1 테두리 색상"><span class="material-icons">smartphone</span><input type="color" value="#ffffff" oninput="changeP1BorderColor(this.value)"></div>
            <div class="menu-item" data-title="P1 글씨 색상"><span class="material-icons">text_fields</span><input type="color" value="#333333" oninput="changeP1TextColor(this.value)"></div>
        </div>
        <div class="divider"></div>
        <div class="menu-group">
             <div class="menu-item" data-title="다크 모드" onclick="toggleDarkMode()"><span class="material-icons">dark_mode</span></div>
            <button onclick="saveImage()" class="save-btn-round" data-title="이미지 저장"><span class="material-icons" style="color:white">save_alt</span></button>
        </div>
    </nav>
    
    <!-- Right Sidebar (P2 Controls) -->
    <nav class="sidebar right-sidebar hide-on-save" id="p2-sidebar" style="display:none;">
        <div class="menu-group">
            <div class="menu-item" data-title="P2 테두리 색상"><span class="material-icons">smartphone</span><input type="color" value="#ffffff" oninput="changeBorderColor(this.value, 'p2-frame')"></div>
            <div class="menu-item" data-title="P2 글씨 색상"><span class="material-icons">text_fields</span><input type="color" value="#333333" oninput="changeP2TextColor(this.value)"></div>
        </div>
        <div class="divider"></div>
        <div class="menu-group">
            <div class="menu-item" data-title="페어명 폰트 변경" onclick="cyclePairFont()"><span class="material-icons">font_download</span></div>
            <div class="menu-item" data-title="페어명 색상"><span class="material-icons">palette</span><input type="color" value="#333333" oninput="changePairColor(this.value)"></div>
        </div>
    </nav>
    
    <!-- Modals -->
    <div id="reset-modal" class="modal hide-on-save" onclick="closeModalOnClickOutside(event, 'reset-modal')">
        <div class="modal-content"><h3>초기화 하시겠습니까?</h3><p>모든 내용이 사라집니다.</p><div class="modal-btns"><button onclick="resetPage()">초기화</button><button onclick="closeResetModal()" style="background:#ddd; color:#333">취소</button></div></div>
    </div>
    <div id="toast-modal" class="modal hide-on-save"><div class="modal-content"><h3>완료</h3></div></div>
    <div id="cropper-modal" class="modal hide-on-save"><div class="modal-content cropper-content"><h3>이미지 편집</h3><div class="canvas-container"><canvas id="cropper-canvas"></canvas></div><div class="cropper-controls"><input type="range" id="crop-zoom" min="0.1" max="3" step="0.1" value="1"><button onclick="rotateImage(90)">Rotate</button></div><div class="modal-btns"><button onclick="applyCrop()">적용</button><button onclick="closeCropper()">취소</button></div></div></div>

    <!-- [3] 기존 Sheet Container -->
    <div id="sheet-container" class="sheet mode-1">
        <div id="sticker-layer"></div>
        <div class="copyright-fixed auto-shrink" contenteditable="true" spellcheck="false" data-default="ⓒ 이미지 출처" oninput="autoFitText(this)">ⓒ 이미지 출처</div>
        
        <div id="pair-name-wrapper" style="display:none;">
            <div id="pair-name-container" class="pair-name font-style-1 auto-shrink" contenteditable="true" spellcheck="false" data-default="Pair Name" oninput="autoFitText(this)">Pair Name</div>
        </div>

        <!-- P1 Profile -->
        <div class="profile-set" id="p1-set">
            <div class="phone-frame" id="p1-frame">
                <div class="main-pic-area" id="p1-main-bg"><div class="placeholder-text no-select"><span class="material-icons-outlined">add_photo_alternate</span><br>Upload</div><input type="file" accept="image/*" onchange="openCropper(event, 'p1-main-bg')"></div>
                <div class="status-bar glass-bar no-select"><span class="material-icons small">close</span><span class="status-title">프로필</span><span class="material-icons small">more_horiz</span></div>
                <div class="music-player glass-effect music-box" id="p1-music">
                    <div class="album-art" id="p1-album-bg"><span class="material-icons-outlined placeholder no-select">album</span><input type="file" accept="image/*" onchange="openCropper(event, 'p1-album-bg')"></div>
                    <div class="music-info"><div class="song-title auto-shrink" contenteditable="true">Title</div><div class="artist-name auto-shrink" contenteditable="true">Artist</div></div>
                </div>
                <div class="dock-bar glass-bar no-select"><div class="dock-item"><span class="material-icons">chat_bubble</span></div><div class="dock-item"><span class="material-icons">call</span></div><div class="dock-item"><span class="material-icons">videocam</span></div></div>
            </div>
            <div class="info-frame">
                <div class="bubble-row"><div class="bubble" id="p1-bubble"><span class="auto-shrink" contenteditable="true">한마디를 입력하세요.</span></div></div>
                <div class="sub-list">
                    <div class="sub-row">
                        <div class="sub-img" id="p1-sub1"><span class="plus">+</span><input type="file" accept="image/*" onchange="openCropper(event, 'p1-sub1')"></div>
                        <div class="sub-text-group"><strong class="auto-shrink" contenteditable="true">외적특징</strong><div class="sub-description auto-shrink" contenteditable="true">설명 입력</div></div>
                    </div>
                </div>
                <div class="profile-card">
                    <div class="name-row"><div class="name-texts"><h1 contenteditable="true" class="auto-shrink">이름</h1></div></div>
                    <div class="stats-line auto-shrink" contenteditable="true">성별 | 나이 | 키cm | 몸무게kg</div>
                </div>
            </div>
        </div> 
        
        <!-- P2 Profile (Hidden by default) -->
        <div class="profile-set" id="p2-set" style="display: none;">
            <div class="phone-frame" id="p2-frame">
                <div class="main-pic-area" id="p2-main-bg"><div class="placeholder-text no-select"><span class="material-icons-outlined">add_photo_alternate</span><br>Upload</div><input type="file" accept="image/*" onchange="openCropper(event, 'p2-main-bg')"></div>
                <div class="status-bar glass-bar no-select"><span class="material-icons small">close</span><span class="status-title">프로필</span><span class="material-icons small">more_horiz</span></div>
                <div class="music-player glass-effect music-box" id="p2-music">
                    <div class="album-art" id="p2-album-bg"><span class="material-icons-outlined placeholder no-select">album</span><input type="file" accept="image/*" onchange="openCropper(event, 'p2-album-bg')"></div>
                    <div class="music-info"><div class="song-title auto-shrink" contenteditable="true">Title</div><div class="artist-name auto-shrink" contenteditable="true">Artist</div></div>
                </div>
                 <div class="dock-bar glass-bar no-select"><div class="dock-item"><span class="material-icons">chat_bubble</span></div><div class="dock-item"><span class="material-icons">call</span></div><div class="dock-item"><span class="material-icons">videocam</span></div></div>
            </div>
            <div class="info-frame">
                <div class="bubble-row"><div class="bubble" id="p2-bubble"><span class="auto-shrink" contenteditable="true">한마디를 입력하세요.</span></div></div>
                <div class="sub-list">
                    <div class="sub-row">
                        <div class="sub-img" id="p2-sub2"><span class="plus">+</span><input type="file" accept="image/*" onchange="openCropper(event, 'p2-sub2')"></div>
                        <div class="sub-text-group"><strong class="auto-shrink" contenteditable="true">외적특징</strong><div class="sub-description auto-shrink" contenteditable="true">설명 입력</div></div>
                    </div>
                </div>
                 <div class="profile-card">
                    <div class="name-row"><div class="name-texts"><h1 contenteditable="true" class="auto-shrink">이름</h1></div></div>
                    <div class="stats-line auto-shrink" contenteditable="true">성별 | 나이 | 키cm | 몸무게kg</div>
                </div>
            </div>
        </div>
    </div>

    <!-- [4] 다인용 Multiplayer Wrapper -->
    <div id="mp-wrapper" class="hide-on-save">
        <div id="multiplayer-container">
            <!-- Cards will be injected via JS -->
        </div>
        <div class="add-card-btn hide-on-save" onclick="addCard()" title="인원 추가 (최대 5명)">
            <span class="material-icons" style="font-size: 32px;">add</span>
        </div>
    </div>

    <!-- [5] 통합 JS -->
    <script>
        // --- 1. Global Variables & Mode ---
        let isMultiplayer = false;
        let cardCount = 0;
        const maxCards = 5;

        // --- 2. Mode Switching Logic ---
        function toggleMultiplayerMode() {
            isMultiplayer = !isMultiplayer;
            const sheet = document.getElementById('sheet-container');
            const mpWrapper = document.getElementById('mp-wrapper');
            const btnText = document.getElementById('mode-text');
            const body = document.body;

            if (isMultiplayer) {
                // Switch to Multiplayer
                sheet.style.display = 'none';
                mpWrapper.classList.add('active');
                body.classList.add('multiplayer-active');
                btnText.textContent = '기본 모드로 전환';
                
                // Initialize if empty
                if(document.getElementById('multiplayer-container').children.length === 0) {
                    addCard();
                }
            } else {
                // Switch to Original
                sheet.style.display = 'flex';
                mpWrapper.classList.remove('active');
                body.classList.remove('multiplayer-active');
                btnText.textContent = '다인용 모드로 전환';
            }
        }

        // --- 3. Original Logic (Refactored from script.js) ---
        function loadImage(event, id) {
            const container = document.getElementById(id);
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    container.style.backgroundImage = 'url(' + e.target.result + ')';
                    const ph = container.querySelector('.placeholder-text, .plus, .placeholder');
                    if(ph) ph.style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        }
        function loadBackgroundImage(event) {
            const sheet = document.getElementById('sheet-container');
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) { sheet.style.backgroundImage = 'url(' + e.target.result + ')'; }
                reader.readAsDataURL(file);
            }
        }
        function changeSheetColor(color) {
            const sheet = document.getElementById('sheet-container');
            sheet.style.backgroundImage = 'none';
            sheet.style.backgroundColor = color;
        }
        function changeBorderColor(color, frameId) { document.getElementById(frameId).style.borderColor = color; }
        
        // P1 Controls
        function changeP1TextColor(color) { document.documentElement.style.setProperty('--p1-text', color); }
        function changeP1BorderColor(color) { changeBorderColor(color, 'p1-frame'); }
        
        function setMode(mode) {
            const sheet = document.getElementById('sheet-container');
            const p2Set = document.getElementById('p2-set');
            const p2Sidebar = document.getElementById('p2-sidebar');
            if (mode === 1) {
                sheet.classList.remove('mode-2'); sheet.classList.add('mode-1');
                p2Set.style.opacity = '0'; p2Set.style.width = '0';
                p2Sidebar.style.display = 'none';
                document.getElementById('pair-name-wrapper').style.display = 'none';
            } else {
                sheet.classList.remove('mode-1'); sheet.classList.add('mode-2');
                p2Set.style.display = 'flex';
                setTimeout(() => { p2Set.style.opacity = '1'; p2Set.style.width = '640px'; }, 10);
                p2Sidebar.style.display = 'flex';
                document.getElementById('pair-name-wrapper').style.display = 'flex';
            }
        }
        
        function toggleDarkMode() { 
            document.body.classList.toggle('dark-mode'); 
        }

        function autoFitText(element) {
            // Original logic for sheet
            let fontSize = parseFloat(window.getComputedStyle(element).fontSize);
            if (!element.dataset.originalSize) { element.dataset.originalSize = fontSize; }
            const maxFontSize = parseFloat(element.dataset.originalSize);
            const minFontSize = 8;
            element.style.fontSize = maxFontSize + 'px';
            fontSize = maxFontSize;
            while ( (element.scrollWidth > element.clientWidth || element.scrollHeight > element.clientHeight) && fontSize > minFontSize ) {
                fontSize -= 0.5;
                element.style.fontSize = fontSize + 'px';
            }
        }

        // --- 4. Multiplayer Logic ---
        function autoShrinkText(element) {
            // New logic for MP
            if (!element.dataset.originalSize) {
                let style = window.getComputedStyle(element, null).getPropertyValue('font-size');
                element.dataset.originalSize = parseFloat(style); 
            }
            const maxFontSize = parseFloat(element.dataset.originalSize);
            const minFontSize = 8; 
            let currentFontSize = maxFontSize;
            element.style.fontSize = maxFontSize + 'px';
            while (element.scrollWidth > element.clientWidth && currentFontSize > minFontSize) {
                currentFontSize -= 1;
                element.style.fontSize = currentFontSize + 'px';
            }
        }

        function addCard() {
            if (cardCount >= maxCards) return;
            cardCount++;
            
            const container = document.getElementById('multiplayer-container');
            const cardId = 'mp-card-' + Date.now();
            const card = document.createElement('div');
            card.className = 'mp-card';
            card.id = cardId;
            
            card.innerHTML = `
                <div class="delete-card-btn hide-on-save" onclick="removeCard('${cardId}')">
                    <span class="material-icons" style="font-size: 16px;">close</span>
                </div>
                <div class="mp-header">
                    <div class="mp-number-badge" style="background-color: #ddd;">
                        <span class="mp-number-text">${cardCount}</span>
                        <input type="color" oninput="changeMpBadgeColor(this)" class="hide-on-save">
                    </div>
                    <div class="mp-titles">
                        <div class="mp-title-main" contenteditable="true" spellcheck="false" oninput="autoShrinkText(this)">한자/한글</div>
                        <div class="mp-title-sub" contenteditable="true" spellcheck="false">NAME</div>
                    </div>
                </div>
                <div class="mp-image-area" onclick="triggerMpUpload(this)">
                    <div class="mp-placeholder">
                        <span class="material-icons" style="font-size: 40px; color:#aaa;">add_a_photo</span><br>
                        사진 등록
                    </div>
                    <input type="file" accept="image/*" onchange="loadMpImage(this)">
                </div>
                <div class="mp-info">
                    <div class="mp-name-kor" contenteditable="true" spellcheck="false" oninput="autoShrinkText(this)">한글이름</div>
                    <div class="mp-palette">
                        <div class="mp-color-dot">
                            <div class="mp-dot" style="background-color: #ffffff;">
                                <input type="color" value="#ffffff" oninput="changeDotColor(this)" class="hide-on-save">
                            </div>
                            <span class="mp-dot-label">HAIR</span>
                        </div>
                        <div class="mp-color-dot">
                            <div class="mp-dot" style="background-color: #ffffff;">
                                <input type="color" value="#ffffff" oninput="changeDotColor(this)" class="hide-on-save">
                            </div>
                            <span class="mp-dot-label">EYE(L)</span>
                        </div>
                        <div class="mp-color-dot">
                            <div class="mp-dot" style="background-color: #ffffff;">
                                <input type="color" value="#ffffff" oninput="changeDotColor(this)" class="hide-on-save">
                            </div>
                            <span class="mp-dot-label">EYE(R)</span>
                        </div>
                    </div>
                    <div class="mp-stats" contenteditable="true" spellcheck="false" oninput="autoShrinkText(this)">키cm/나이</div>
                </div>
                <div class="mp-desc-box" contenteditable="true" data-placeholder="설명을 입력하세요..."></div>
            `;
            container.appendChild(card);
            renumberCards();
            updateAddButtonVisibility();
        }

        function removeCard(id) {
            const card = document.getElementById(id);
            if(card) {
                card.remove();
                cardCount--;
                renumberCards();
                updateAddButtonVisibility();
            }
        }

        function renumberCards() {
            const badges = document.querySelectorAll('.mp-number-text');
            badges.forEach((span, index) => { span.textContent = index + 1; });
        }
        function updateAddButtonVisibility() {
            const addBtn = document.querySelector('.add-card-btn');
            addBtn.style.display = (cardCount >= maxCards) ? 'none' : 'flex';
        }

        function triggerMpUpload(div) { div.querySelector('input').click(); }
        function loadMpImage(input) {
            const file = input.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const parent = input.parentElement;
                    parent.style.backgroundImage = 'url(' + e.target.result + ')';
                    parent.querySelector('.mp-placeholder').style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        }
        function changeMpBadgeColor(input) { input.parentElement.style.backgroundColor = input.value; }
        function changeDotColor(input) { input.parentElement.style.backgroundColor = input.value; }

        // --- 5. Integrated Save Function ---
        function saveImage() {
            // Decide target based on active mode
            const targetId = isMultiplayer ? 'multiplayer-container' : 'sheet-container';
            const element = document.getElementById(targetId);
            const body = document.body;

            body.classList.add('capturing');
            
            // UI elements to hide are handled by CSS (.hide-on-save)
            
            html2canvas(element, {
                scale: 2,
                backgroundColor: null, 
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                try {
                    const link = document.createElement("a");
                    link.download = 'character_sheet_' + Date.now() + '.png';
                    link.href = canvas.toDataURL("image/png");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } catch (err) { alert("저장 오류: " + err); }
                body.classList.remove('capturing');
            }).catch(err => {
                body.classList.remove('capturing');
                alert('저장 실패: ' + err);
            });
        }
        
        // --- 6. Helper for UI Toggle ---
        function toggleUI() {
            document.body.classList.toggle('ui-hidden');
        }
        
        // --- 7. Cropper Logic (Stub - Basic functionality) ---
        let currentCropTargetId = null;
        function openCropper(event, targetId) {
            // Simple pass-through for now, full cropper logic is heavy to embed inline but keeping structure
            loadImage(event, targetId); 
        }
        function closeCropper() { document.getElementById('cropper-modal').classList.remove('show'); }

    </script>
</body>
</html>
